# Linux診断フローチャート

症状別の診断手順をフローチャート形式で解説します。

---

## 総合診断フロー

問題の切り分けを行う初動フローです。

```
                    ┌─────────────────┐
                    │   問題発生！    │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │  初動確認実施   │
                    │  uptime / free  │
                    │  df -h / dmesg  │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
┌───────▼───────┐   ┌────────▼────────┐   ┌───────▼───────┐
│ Load Average  │   │   メモリ不足    │   │  ディスク関連  │
│    が高い     │   │  (free確認)     │   │   (df確認)     │
└───────┬───────┘   └────────┬────────┘   └───────┬───────┘
        │                    │                    │
        ▼                    ▼                    ▼
   CPU診断へ            メモリ診断へ         ディスク診断へ


        ┌────────────────────┼────────────────────┐
        │                    │                    │
┌───────▼───────┐   ┌────────▼────────┐   ┌───────▼───────┐
│ ネットワーク  │   │   サービス      │   │   原因不明    │
│   接続問題    │   │  起動しない     │   │   エラー      │
└───────┬───────┘   └────────┬────────┘   └───────┬───────┘
        │                    │                    │
        ▼                    ▼                    ▼
  ネットワーク診断へ    サービス診断へ        ログ診断へ
```

---

## 1. CPU高負荷診断フロー

```
┌─────────────────────────────────────────────────────────────┐
│                    CPU高負荷診断                            │
└─────────────────────────────────────────────────────────────┘

            ┌─────────────────┐
            │ uptime で確認   │
            │ Load Average?   │
            └────────┬────────┘
                     │
     ┌───────────────┼───────────────┐
     │               │               │
     ▼               ▼               ▼
 < コア数       ≈ コア数        > コア数
   (正常)        (注意)          (過負荷)
                                    │
                     ┌──────────────┴──────────────┐
                     │     top / htop で確認       │
                     │   CPU使用率が高いのは?      │
                     └──────────────┬──────────────┘
                                    │
        ┌───────────────────────────┼───────────────────────────┐
        │                           │                           │
        ▼                           ▼                           ▼
   us (user) 高い             sy (system) 高い            wa (iowait) 高い
        │                           │                           │
        ▼                           ▼                           ▼
┌───────────────────┐     ┌───────────────────┐     ┌───────────────────┐
│ アプリケーション  │     │ カーネル/ドライバ │     │   I/O ボトルネック │
│ の問題            │     │ の問題            │     │                   │
└─────────┬─────────┘     └─────────┬─────────┘     └─────────┬─────────┘
          │                         │                         │
          ▼                         ▼                         ▼
┌───────────────────┐     ┌───────────────────┐     ┌───────────────────┐
│ ps aux --sort=-%cpu│    │ dmesg でエラー確認│     │ iostat -x 1 5     │
│ で特定            │     │                   │     │ でディスク確認    │
└───────────────────┘     └───────────────────┘     └───────────────────┘

【対処の指針】
- us高い → 該当プロセスの調査・最適化・停止
- sy高い → カーネルログ確認、ドライバ問題調査
- wa高い → ディスク診断フローへ移行
```

---

## 2. メモリ診断フロー

```
┌─────────────────────────────────────────────────────────────┐
│                    メモリ診断                               │
└─────────────────────────────────────────────────────────────┘

            ┌─────────────────┐
            │   free -h 実行  │
            └────────┬────────┘
                     │
     ┌───────────────┼───────────────┐
     │               │               │
     ▼               ▼               ▼
available十分    available少ない   Swap使用大
   (正常)            │               │
                     │               │
                     └───────┬───────┘
                             │
                     ┌───────▼───────┐
                     │ OOM発生確認   │
                     │ dmesg | grep  │
                     │    -i oom     │
                     └───────┬───────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
   OOM発生あり          OOM発生なし          継続的にSwap増加
        │                    │                    │
        ▼                    ▼                    ▼
┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐
│ OOM Killerログ確認│ │ メモリリーク調査  │ │ vmstat 1 で監視   │
│ どのプロセスが    │ │ ps aux --sort=-%mem│ │ si/so 列を確認   │
│ 殺されたか確認    │ │ で上位確認        │ │                   │
└─────────┬─────────┘ └─────────┬─────────┘ └─────────┬─────────┘
          │                     │                     │
          ▼                     ▼                     ▼
┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐
│ 該当プロセスの    │ │ pmap -x <PID> で  │ │ Swap追加検討      │
│ メモリ設定見直し  │ │ 詳細確認          │ │ またはメモリ増設  │
└───────────────────┘ └───────────────────┘ └───────────────────┘

【メモリ関連の重要指標】
- available: 実際に利用可能なメモリ量
- buff/cache: 解放可能なバッファ/キャッシュ
- si/so (vmstat): Swap In/Out（多いと性能低下）
```

---

## 3. ディスク診断フロー

```
┌─────────────────────────────────────────────────────────────┐
│                    ディスク診断                             │
└─────────────────────────────────────────────────────────────┘

            ┌─────────────────┐
            │    df -h 実行   │
            └────────┬────────┘
                     │
     ┌───────────────┼───────────────┐
     │               │               │
     ▼               ▼               ▼
  Use% < 80%     Use% 80-95%      Use% > 95%
   (正常)          (注意)          (危険)
                     │               │
                     └───────┬───────┘
                             │
                     ┌───────▼───────┐
                     │ 大きなファイル │
                     │   検索        │
                     │ du -sh /*     │
                     │ find -size    │
                     └───────┬───────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
   /var が大きい        /tmp が大きい       /home が大きい
        │                    │                    │
        ▼                    ▼                    ▼
┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐
│ ログファイル確認  │ │ 一時ファイル確認  │ │ ユーザーデータ    │
│ /var/log の整理   │ │ 古いファイル削除  │ │ 整理を検討        │
└───────────────────┘ └───────────────────┘ └───────────────────┘


                    【I/O性能問題の場合】

            ┌─────────────────┐
            │ iostat -x 1 5   │
            └────────┬────────┘
                     │
     ┌───────────────┼───────────────┐
     │               │               │
     ▼               ▼               ▼
  %util低い      %util 50-80%     %util > 90%
   (正常)          (注意)         (飽和状態)
                                      │
                              ┌───────▼───────┐
                              │  iotop で     │
                              │ I/O負荷プロセス│
                              │    特定       │
                              └───────┬───────┘
                                      │
                              ┌───────▼───────┐
                              │ 該当プロセスの │
                              │ I/Oパターン   │
                              │  最適化検討   │
                              └───────────────┘

【ディスク関連の重要指標】
- %util: デバイス使用率（100%で飽和）
- await: I/O待ち時間（大きいと遅延）
- inode使用率: df -i で確認（枯渇すると書き込み不可）
```

---

## 4. ネットワーク診断フロー

```
┌─────────────────────────────────────────────────────────────┐
│                    ネットワーク診断                         │
└─────────────────────────────────────────────────────────────┘

            ┌─────────────────┐
            │  ip addr 実行   │
            │  IPアドレス確認 │
            └────────┬────────┘
                     │
     ┌───────────────┼───────────────┐
     │               │               │
     ▼               ▼               ▼
  IPアドレス      IPなし/DOWN      リンクダウン
    あり             │               │
     │               ▼               ▼
     │      ┌───────────────┐ ┌───────────────┐
     │      │ DHCP再取得    │ │ 物理接続確認  │
     │      │ ケーブル確認  │ │ ip link set   │
     │      └───────────────┘ └───────────────┘
     │
     ▼
┌─────────────────┐
│ ping 127.0.0.1  │
│ (ローカルループ)│
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
  成功       失敗
    │         │
    │         ▼
    │    ┌───────────────┐
    │    │ ネットワーク  │
    │    │ スタック問題  │
    │    └───────────────┘
    │
    ▼
┌─────────────────┐
│ ping ゲートウェイ│
│ (ip route確認)  │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
  成功       失敗
    │         │
    │         ▼
    │    ┌───────────────┐
    │    │ ルーティング  │
    │    │ またはL2問題  │
    │    │ arp -n 確認   │
    │    └───────────────┘
    │
    ▼
┌─────────────────┐
│ ping 8.8.8.8    │
│ (外部IP直接)    │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
  成功       失敗
    │         │
    │         ▼
    │    ┌───────────────┐
    │    │ ファイアウォール│
    │    │ またはISP問題  │
    │    │ traceroute確認│
    │    └───────────────┘
    │
    ▼
┌─────────────────┐
│ ping google.com │
│ (DNS解決)       │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
  成功       失敗
    │         │
    ▼         ▼
 正常     ┌───────────────┐
          │ DNS問題       │
          │ /etc/resolv.conf│
          │ 確認          │
          └───────────────┘

【ポート接続問題の場合】

┌─────────────────┐
│ ss -tlnp で     │
│ リスニング確認  │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
ポートLISTEN  LISTENなし
    │              │
    ▼              ▼
┌───────────────┐ ┌───────────────┐
│ ファイアウォール│ │ サービス起動  │
│ 確認           │ │ 確認          │
│ iptables -L -n│ │ systemctl     │
└───────────────┘ └───────────────┘
```

---

## 5. サービス診断フロー

```
┌─────────────────────────────────────────────────────────────┐
│                    サービス診断                             │
└─────────────────────────────────────────────────────────────┘

            ┌─────────────────────┐
            │ systemctl status    │
            │     <service>       │
            └──────────┬──────────┘
                       │
     ┌─────────────────┼─────────────────┐
     │                 │                 │
     ▼                 ▼                 ▼
  active            inactive          failed
 (running)         (dead)               │
     │                 │                 │
  正常動作             │                 │
                       │                 │
     ┌─────────────────┴─────────────────┐
     │                                   │
     ▼                                   ▼
┌───────────────────┐           ┌───────────────────┐
│ 手動で起動試行    │           │ ログでエラー確認  │
│ systemctl start   │           │ journalctl -u     │
│    <service>      │           │    <service>      │
└─────────┬─────────┘           └─────────┬─────────┘
          │                               │
     ┌────┴────┐                          │
     │         │                          │
     ▼         ▼                          │
   成功       失敗 ◄──────────────────────┘
     │         │
     │         ▼
     │    ┌───────────────────┐
     │    │ エラーメッセージ  │
     │    │ から原因特定      │
     │    └─────────┬─────────┘
     │              │
     │    ┌─────────┼─────────────────────┐
     │    │         │                     │
     │    ▼         ▼                     ▼
     │  設定エラー  依存関係エラー       権限エラー
     │    │         │                     │
     │    ▼         ▼                     ▼
     │ ┌─────────┐ ┌─────────────────┐ ┌─────────────────┐
     │ │設定ファイル│ │systemctl list-  │ │ファイル権限確認│
     │ │構文確認  │ │dependencies確認 │ │ls -la          │
     │ └─────────┘ └─────────────────┘ └─────────────────┘
     │
     ▼
┌───────────────────────┐
│ 自動起動設定確認      │
│ systemctl is-enabled  │
│ 必要なら enable       │
└───────────────────────┘

【よくあるエラーと対処】
┌─────────────────────────────────────────────────────────────┐
│ エラー                    │ 対処                           │
├─────────────────────────────────────────────────────────────┤
│ Port already in use       │ ss -tlnp でポート使用確認      │
│ Permission denied         │ ファイル/ディレクトリ権限確認  │
│ Configuration error       │ 設定ファイル構文チェック       │
│ Dependency failed         │ 依存サービスの状態確認         │
│ Timeout                   │ 起動スクリプト/設定確認        │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. ログ診断フロー

```
┌─────────────────────────────────────────────────────────────┐
│                    ログ診断                                 │
└─────────────────────────────────────────────────────────────┘

            ┌─────────────────┐
            │ 問題発生時刻を  │
            │   特定する      │
            └────────┬────────┘
                     │
                     ▼
            ┌─────────────────┐
            │ journalctl で   │
            │ 時刻範囲指定    │
            │ --since "時刻"  │
            └────────┬────────┘
                     │
     ┌───────────────┼───────────────┐
     │               │               │
     ▼               ▼               ▼
カーネル関連    アプリ関連     認証関連
     │               │               │
     ▼               ▼               ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│ dmesg -T      │ │ journalctl -u │ │ journalctl    │
│ journalctl -k │ │   <service>   │ │ _COMM=sshd    │
└───────────────┘ └───────────────┘ └───────────────┘


              【エラーレベルでフィルタ】

┌─────────────────────────────────────────────────────────────┐
│ journalctl -p <level>                                       │
├─────────────────────────────────────────────────────────────┤
│ emerg  (0) │ システム使用不能                               │
│ alert  (1) │ 即時対応必要                                   │
│ crit   (2) │ 重大なエラー                                   │
│ err    (3) │ エラー                                         │
│ warning(4) │ 警告                                           │
│ notice (5) │ 正常だが重要                                   │
│ info   (6) │ 情報                                           │
│ debug  (7) │ デバッグ                                       │
└─────────────────────────────────────────────────────────────┘

            ┌─────────────────┐
            │ エラー抽出      │
            │ journalctl -p err│
            └────────┬────────┘
                     │
                     ▼
            ┌─────────────────┐
            │ 関連キーワード  │
            │ で grep         │
            └────────┬────────┘
                     │
                     ▼
            ┌─────────────────┐
            │ 該当するエラー  │
            │ メッセージを    │
            │ 調査・対処      │
            └─────────────────┘

【ログ調査のポイント】
1. 発生時刻を特定してからログを見る
2. エラーレベルでフィルタして絞り込む
3. 直前・直後のログも確認（コンテキスト理解）
4. 繰り返しパターンがないか確認
```

---

## 診断チェックリスト

迅速な診断のためのチェックリストです。

### 初動チェック（全問題共通）

```
□ uptime - Load Average確認
□ free -h - メモリ使用状況
□ df -h - ディスク使用状況
□ dmesg | tail -30 - 最近のカーネルメッセージ
□ journalctl -p err -n 20 - 最近のエラー
```

### CPU問題チェック

```
□ Load Average > CPUコア数？
□ top で CPU使用率上位プロセス特定
□ vmstat で us/sy/wa 確認
□ wa が高い場合は I/O問題を疑う
```

### メモリ問題チェック

```
□ available メモリが十分か？
□ Swap使用量が大きくないか？
□ OOM Killer発動履歴確認
□ メモリ使用上位プロセス特定
```

### ディスク問題チェック

```
□ 使用率が90%を超えていないか？
□ inode使用率は大丈夫か？
□ iostat で %util 確認
□ 大きなファイル/ディレクトリ特定
```

### ネットワーク問題チェック

```
□ IPアドレス取得できているか？
□ ゲートウェイにping通るか？
□ DNS解決できるか？
□ 目的のポートがLISTENしているか？
□ ファイアウォールでブロックされていないか？
```

### サービス問題チェック

```
□ サービスの状態（active/inactive/failed）
□ エラーログの内容
□ 設定ファイルの構文
□ 依存サービスの状態
□ ポート競合の有無
```

---

## 7. GPU/NVIDIA診断フロー

```
┌─────────────────────────────────────────────────────────────┐
│                    GPU/NVIDIA診断                           │
└─────────────────────────────────────────────────────────────┘

            ┌─────────────────┐
            │  nvidia-smi    │
            │    実行        │
            └────────┬────────┘
                     │
     ┌───────────────┼───────────────┐
     │               │               │
     ▼               ▼               ▼
   正常出力     コマンド未発見    エラー発生
     │               │               │
     │               ▼               ▼
     │      ┌───────────────┐ ┌───────────────────┐
     │      │ ドライバ未     │ │ "Failed to       │
     │      │ インストール   │ │ initialize NVML" │
     │      └───────────────┘ └─────────┬─────────┘
     │                                  │
     │                          ┌───────▼───────┐
     │                          │ Persistence   │
     │                          │ Mode 確認     │
     │                          │nvidia-smi -q  │
     │                          │ |grep Persist │
     │                          └───────┬───────┘
     │                                  │
     │                     ┌────────────┼────────────┐
     │                     │                         │
     │                     ▼                         ▼
     │               Disabled                    Enabled
     │                     │                         │
     │                     ▼                         ▼
     │            ┌───────────────┐        ┌───────────────┐
     │            │ sudo nvidia-  │        │ カーネルログ  │
     │            │ smi -pm 1     │        │ 確認          │
     │            │ で有効化      │        │ dmesg|grep    │
     │            └───────────────┘        │ nvidia        │
     │                                     └───────────────┘
     │
     ▼
┌─────────────────┐
│ Persistence     │
│ Mode 確認       │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
Enabled    Disabled
  (OK)        │
              ▼
     ┌───────────────────┐
     │ 長時間運用で問題  │
     │ が発生する可能性  │
     │ → 有効化推奨      │
     └───────────────────┘

【Persistence Mode有効化の永続化】
┌─────────────────────────────────────────────────────────────┐
│ 1. nvidia-persistenced.service の設定変更                   │
│    sudo systemctl edit nvidia-persistenced.service          │
│                                                             │
│ 2. 専用サービス作成                                         │
│    /etc/systemd/system/nvidia-persistence-mode.service      │
│    ExecStart=/usr/bin/nvidia-smi -pm 1                      │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. グラフィック/xrdp診断フロー

```
┌─────────────────────────────────────────────────────────────┐
│                    xrdp黒画面診断                           │
└─────────────────────────────────────────────────────────────┘

            ┌─────────────────┐
            │ systemctl status│
            │ xrdp xrdp-sesman│
            └────────┬────────┘
                     │
     ┌───────────────┼───────────────┐
     │               │               │
     ▼               ▼               ▼
  両方active    一方がfailed     両方inactive
     │               │               │
     │               ▼               ▼
     │      ┌───────────────┐ ┌───────────────┐
     │      │ journalctl -u │ │ systemctl     │
     │      │ でエラー確認  │ │ start xrdp    │
     │      └───────────────┘ └───────────────┘
     │
     ▼
┌─────────────────┐
│ groups | grep   │
│    video        │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
  あり       なし
    │         │
    │         ▼
    │    ┌───────────────────┐
    │    │ sudo usermod -aG  │
    │    │ video $USER       │
    │    │ → 再ログイン必要  │
    │    └───────────────────┘
    │
    ▼
┌─────────────────┐
│ Xorgログ確認    │
│ ~/.xorgxrdp.*   │
│ .log | grep EE  │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
エラーあり  エラーなし
    │            │
    ▼            ▼
┌───────────────┐ ┌───────────────────┐
│ systemd-logind│ │ ソフトウェア      │
│ DRM権限エラー?│ │ レンダリング設定  │
│ → video group │ │ 確認              │
│   ACL設定     │ │ ~/.xsession       │
└───────────────┘ └─────────┬─────────┘
                            │
                   ┌────────┴────────┐
                   │                 │
                   ▼                 ▼
              設定あり            設定なし
                (OK)                 │
                                     ▼
                            ┌───────────────────┐
                            │ ~/.xsession に    │
                            │ 以下を追加:       │
                            │ LIBGL_ALWAYS_     │
                            │ SOFTWARE=1        │
                            │ GALLIUM_DRIVER=   │
                            │ llvmpipe          │
                            └───────────────────┘

【xrdp黒画面の主な原因と対処】
┌─────────────────────────────────────────────────────────────┐
│ 原因                        │ 対処                         │
├─────────────────────────────────────────────────────────────┤
│ videoグループ未所属         │ usermod -aG video $USER      │
│ DRMデバイス権限不足         │ setfacl / udevルール         │
│ ハードウェアレンダリング失敗 │ ソフトウェアレンダリング強制 │
│ H.264コーデック非互換       │ RFXコーデックに変更          │
└─────────────────────────────────────────────────────────────┘
```

---

## 9. Docker/コンテナGPU診断フロー

```
┌─────────────────────────────────────────────────────────────┐
│                    コンテナGPU診断                          │
└─────────────────────────────────────────────────────────────┘

            ┌─────────────────┐
            │ ホスト側で      │
            │ nvidia-smi     │
            └────────┬────────┘
                     │
     ┌───────────────┼───────────────┐
     │               │               │
     ▼               ▼               ▼
   正常出力       エラー発生      コマンド未発見
     │               │               │
     │               ▼               ▼
     │      ┌───────────────┐ ┌───────────────┐
     │      │ ホスト側GPU   │ │ ドライバ      │
     │      │ 問題を先に解決│ │ インストール  │
     │      └───────────────┘ └───────────────┘
     │
     ▼
┌─────────────────────┐
│ docker exec         │
│ <container>         │
│ nvidia-smi          │
└──────────┬──────────┘
           │
     ┌─────┴─────┐
     │           │
     ▼           ▼
  正常出力    エラー発生
    (OK)         │
                 ▼
        ┌───────────────────┐
        │ "Failed to        │
        │ initialize NVML:  │
        │ Unknown Error"    │
        └─────────┬─────────┘
                  │
                  ▼
        ┌───────────────────┐
        │ Persistence Mode  │
        │ 確認              │
        │ nvidia-smi -q     │
        │ |grep Persist     │
        └─────────┬─────────┘
                  │
     ┌────────────┴────────────┐
     │                         │
     ▼                         ▼
 Disabled                   Enabled
     │                         │
     ▼                         ▼
┌───────────────┐     ┌───────────────────┐
│ これが原因！  │     │ docker inspect    │
│ sudo nvidia-  │     │ でGPU設定確認     │
│ smi -pm 1     │     │ DeviceRequests    │
│               │     └─────────┬─────────┘
│ コンテナ再起動│               │
└───────────────┘       ┌───────┴───────┐
                        │               │
                        ▼               ▼
                   設定あり         設定なし
                        │               │
                        ▼               ▼
               ┌───────────────┐ ┌───────────────┐
               │nvidia-container│ │docker-compose │
               │-toolkit確認    │ │でGPU設定追加  │
               │nvidia-container│ │--gpus all     │
               │-cli info      │ └───────────────┘
               └───────────────┘

【コンテナGPU問題のチェックリスト】
┌─────────────────────────────────────────────────────────────┐
│ □ ホスト側でnvidia-smi正常動作                              │
│ □ Persistence Mode: Enabled                                 │
│ □ nvidia-container-toolkit インストール済み                 │
│ □ Docker設定にnvidia runtime登録済み                        │
│ □ コンテナ起動時に--gpus allまたはDeviceRequests設定        │
│ □ コンテナ再起動後も問題が再発しないか                      │
└─────────────────────────────────────────────────────────────┘

【時間経過で発生する問題の場合】
┌─────────────────────────────────────────────────────────────┐
│ 症状: 起動直後は正常、時間経過後にGPUアクセス不可           │
│ 原因: Persistence Mode無効によるドライバ休止                │
│ 解決: sudo nvidia-smi -pm 1 + systemdで永続化               │
└─────────────────────────────────────────────────────────────┘
```

---

## 10. ユーザー権限/ACL診断フロー

```
┌─────────────────────────────────────────────────────────────┐
│                    権限/ACL診断                             │
└─────────────────────────────────────────────────────────────┘

            ┌─────────────────┐
            │ "Permission     │
            │ denied" エラー  │
            └────────┬────────┘
                     │
                     ▼
            ┌─────────────────┐
            │ 対象を特定      │
            │ ファイル？      │
            │ デバイス？      │
            └────────┬────────┘
                     │
     ┌───────────────┼───────────────┐
     │               │               │
     ▼               ▼               ▼
ファイル/Dir    デバイス      その他リソース
     │         (/dev/*)             │
     │               │               │
     ▼               ▼               ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│ ls -la で     │ │ ls -la /dev/  │ │ アプリ固有の  │
│ 権限確認      │ │ でグループ確認│ │ 権限確認      │
└───────┬───────┘ └───────┬───────┘ └───────────────┘
        │               │
        ▼               ▼
┌───────────────┐ ┌───────────────────┐
│ 所有者/グループ│ │ 必要なグループに  │
│ 確認          │ │ 所属しているか？  │
│ - chmod       │ │ groups | grep xxx │
│ - chown       │ └─────────┬─────────┘
└───────────────┘           │
                    ┌───────┴───────┐
                    │               │
                    ▼               ▼
                所属済み         未所属
                    │               │
                    ▼               ▼
           ┌───────────────┐ ┌───────────────────┐
           │ ACL確認       │ │ usermod -aG       │
           │ getfacl       │ │ <group> $USER     │
           │               │ │ → 再ログイン必要  │
           └───────┬───────┘ └───────────────────┘
                   │
          ┌────────┴────────┐
          │                 │
          ▼                 ▼
     ACLで許可         ACLで拒否/なし
        (OK)                │
                            ▼
                   ┌───────────────────┐
                   │ setfacl で        │
                   │ ACL追加           │
                   │ または            │
                   │ udevルール作成    │
                   └───────────────────┘

【重要なグループ一覧】
┌─────────────────────────────────────────────────────────────┐
│ グループ │ 用途                                             │
├─────────────────────────────────────────────────────────────┤
│ video    │ GPU/DRMデバイス（/dev/dri/*）                    │
│ audio    │ オーディオデバイス（/dev/snd/*）                 │
│ docker   │ Dockerコマンド実行                               │
│ sudo     │ 管理者権限                                       │
│ plugdev  │ USB等のプラグアンドプレイデバイス                │
└─────────────────────────────────────────────────────────────┘

【権限変更後の注意】
┌─────────────────────────────────────────────────────────────┐
│ グループ追加後は以下のいずれかが必要:                       │
│ - ログアウト/ログイン                                       │
│ - newgrp <group>（一時的）                                  │
│ - システム再起動                                            │
└─────────────────────────────────────────────────────────────┘
```

---

### GPU問題チェック

```
□ nvidia-smi が正常に動作するか？
□ Persistence Mode は Enabled か？
□ nvidia-persistenced サービスは正常か？
□ カーネルログにnvidiaエラーがないか？
□ ドライババージョンは適切か？
```

### xrdp問題チェック

```
□ xrdp, xrdp-sesmanサービスは active か？
□ ユーザーは video グループに所属しているか？
□ DRMデバイス（/dev/dri/*）にアクセス可能か？
□ Xorgログにエラー（EE）がないか？
□ ソフトウェアレンダリング設定は適切か？
```

### コンテナGPU問題チェック

```
□ ホスト側でnvidia-smi正常動作
□ Persistence Mode: Enabled
□ nvidia-container-toolkit インストール済み
□ コンテナにGPU設定（--gpus all / DeviceRequests）
□ コンテナ内でnvidia-smi正常動作
```

### 権限問題チェック

```
□ 必要なグループに所属しているか（id, groups）
□ ファイル/デバイスの権限確認（ls -la）
□ ACL設定確認（getfacl）
□ SELinux/AppArmor状態確認
□ udevルールは適切か
```
